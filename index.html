<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>JC</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/night.css" />
<script type="text/javascript" src="https://stackedit.io/libs/MathJax/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><h2 id="overview">Overview</h2>

<p>This is Skyrim plugin that implements array and associative(map or dictionary) containers: JArray (array container), JMap and JFormMap (associative containers), JDB (database).</p>

<h4 id="jarray">JArray</h4>

<p>Ordered collection (list) of <strong>values</strong>(value is float, integer, string or another container). Dynamicallys resizeable, unlimited size array (Skyrim size limit is 128) that may contain any kind of in one time.</p>

<h4 id="jmap-and-jformmap">JMap and JFormMap</h4>

<p>Both are <strong>associative</strong> containers (set of unique keys and values where each key associated with one <strong>value</strong>). They can not contain two or more equal keys. JMap key is a string, JFormMap key is a form (form is any actor, item, quest, spell - almost everything in Skyrim).</p>

<h4 id="jvalue">JValue</h4>

<p>Nothing more that just an interface that shows what functionality JArray, JMap and JFormMap share. So each of them can be emptied, serialized and deserialized to/from JSON file and more.</p>

<h4 id="jdb">JDB</h4>

<p>Take it as global entry point or database - you put information in it under “yourKey” string key and then you can access to it from any script in the game. There is only one JDB in game, so each time you access it you access that one, single JDB. It is <strong>associative</strong> container as JMap (it is JMap internally), but script interface slight different. <br>
__ <br>
<em>There are also some pieces of information in script file comments.</em></p>

<h2 id="reference">Reference</h2>

<h3 id="objectcontainer-instantiation-identifiers">Object(container) instantiation, identifiers</h3>

<p>Object <strong>identifier</strong> is unique number that ranges from 1 to 2^32. It’s the way to distinguish it among other objects. And it’s almost only way to interact with it.</p>

<p>To use any container object (array, map or formmap) you must first create(instantiate) it with <code>object</code> function or retrieve it from somewhere:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="kwd">int</span><span class="pln"> array </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JArray</span><span class="pun">.</span><span class="kwd">object</span><span class="pun">()</span><span class="pln">
</span><span class="kwd">int</span><span class="pln"> anotherArray </span><span class="pun">=</span><span class="pln"> JDB</span><span class="pun">.</span><span class="pln">solveObj</span><span class="pun">(</span><span class="str">".myArray"</span><span class="pun">)</span></code></pre>

<p>Once created, you may put something in it:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="typ">JArray</span><span class="pun">.</span><span class="pln">addStr</span><span class="pun">(</span><span class="pln">array</span><span class="pun">,</span><span class="pln"> </span><span class="str">"it’s me"</span><span class="pun">)</span><span class="pln">
</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">addForm</span><span class="pun">(</span><span class="pln">array</span><span class="pun">,</span><span class="pln"> </span><span class="typ">GetTargetActor</span><span class="pun">())</span></code></pre>

<p>And read contents:        </p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="kwd">string</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getStr</span><span class="pun">(</span><span class="pln">array</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln">
form actor </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getForm</span><span class="pun">(</span><span class="pln">array</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></pre>

<h3 id="notes-about-jcontainers-api-usage">Notes about JContainers API usage</h3>

<p>First and foremost - game will not crash no matter what data you will pass into JContainer functions. The following happens if function gets called with invalid input (state when input cannot be handled properly):</p>

<p>All functions returning new container return zero identifier. For. ex <code>JValue.readFromFile("")</code> returns 0 because of invalid file path. Zero identifier means non-existing object. It’s ok to pass it into other functions - in that case function will return default value.</p>

<p>All functions that read container contents (such as getFlt, solveFlt, getStr, count, allKeys and etc) return default value. In case function returns integer or float - default value is 0, string or form - None, container identifier - 0.</p>

<h3 id="object-persistence">Object persistence</h3>

<p>Every container object persists in save file until it (container) gets destroyed. When save performed all objects are saved and all objects are resurrected when save file gets loaded.</p>

<h3 id="json-serialization">JSON serialization</h3>

<p>As said above, it’s possible to serialize/deserialize container data. While numbers and strings serialized in natural way, store form information is slight tricky as JSON knows nothing about Skyrim forms (and also because global form id depends on mod load order). Serialized form is a string prefixed with __formData, plugin file name and local form id (hex or decimal number).</p>

<p>Example of serialized JMap containing player form associated with <code>"test"</code> key:</p>

<pre class="prettyprint prettyprinted"><code class="language-json"><span class="pun">{</span><span class="pln">
    </span><span class="str">"test"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"__formData|Skyrim.esm|0x14"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"name"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Elsa"</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"level"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pln">
</span><span class="pun">}</span></code></pre>

<h3 id="path-resolving">Path resolving</h3>

<p>This feature simplifies access to deep-located information. There is a group of <code>solve*</code> and <code>solve*Setter</code> functions. <code>solve*</code> retrieves value and <code>solve*Setter</code> changes (assigns) value. Suppose there is object info containing following information:</p>

<pre class="prettyprint prettyprinted"><code class="language-json"><span class="pun">{</span><span class="pln">
    </span><span class="str">"classicPreset"</span><span class="pln"> </span><span class="pun">:</span><span class="pln">  </span><span class="pun">{</span><span class="pln">
    </span><span class="str">"campfileLighting"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"Automatic"</span><span class="pln">
    </span><span class="pun">},</span><span class="pln">
    </span><span class="str">"numbers"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">3</span><span class="pun">]</span><span class="pln">
</span><span class="pun">}</span></code></pre>

<p>Access to campfileLighting in standard way would look like:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="kwd">int</span><span class="pln"> preset </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JMap</span><span class="pun">.</span><span class="pln">getObj</span><span class="pun">(</span><span class="pln">info</span><span class="pun">,</span><span class="pln"> </span><span class="str">"classicPreset"</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> lightingType </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JMap</span><span class="pun">.</span><span class="pln">getStr</span><span class="pun">(</span><span class="pln">preset</span><span class="pun">,</span><span class="pln"> </span><span class="str">"campfileLighting"</span><span class="pun">)</span></code></pre>

<p>But it’s possible to retrieve or change campfileLighting value, get access to numbers array in more simple way:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="kwd">string</span><span class="pln"> lightingType </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveStr</span><span class="pun">(</span><span class="pln">info</span><span class="pun">,</span><span class="pln"> </span><span class="str">".classicPreset.campfileLighting"</span><span class="pun">)</span><span class="pln">
</span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveStrSetter</span><span class="pun">(</span><span class="pln">info</span><span class="pun">,</span><span class="pln"> </span><span class="str">".classicPreset.campfileLighting"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Non-Automatic"</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">int</span><span class="pln"> firstNumber </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveInt</span><span class="pun">(</span><span class="pln">info</span><span class="pun">,</span><span class="pln"> </span><span class="str">".numbers[0]"</span><span class="pun">)</span><span class="pln">
</span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveIntSetter</span><span class="pun">(</span><span class="pln">info</span><span class="pun">,</span><span class="pln"> </span><span class="str">".numbers[0]"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">)</span></code></pre>

<h3 id="collection-operators">Collection operators</h3>

<p>Feature allows execute functions on collection elements. It’s accessible via solve* functions. <br>
Syntax:</p>

<ul>
<li>path.to.container@function</li>
<li>path.to.container@function.path.to.element</li>
</ul>

<p>path.to.container - is the path to retrieve collection</p>

<p>function - is the function that will be applied to each collection item. Currently only few functions implemented:</p>

<ul>
<li>minNum, maxNum (search for min or max number, works with any number type (int or float))</li>
<li>minFlt, maxFlt - the same as above, accepts float values only</li>
<li>minFlt, maxFlt - the same as above, accepts integer values only</li>
</ul>

<p>path.to.element - is the path to retrieve element. <br>
Examples:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="pun">[</span><span class="lit">1</span><span class="pun">,</span><span class="lit">2</span><span class="pun">,</span><span class="lit">3</span><span class="pun">,</span><span class="lit">4</span><span class="pun">,</span><span class="lit">5</span><span class="pun">,</span><span class="lit">6</span><span class="pun">]</span><span class="pln">

solveFlt</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">,</span><span class="pln"> </span><span class="str">"@maxNum"</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">6</span><span class="pln">
solveFlt</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">,</span><span class="pln"> </span><span class="str">"@minNum"</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">1</span><span class="pln">

</span><span class="pun">{</span><span class="pln"> </span><span class="str">"a"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> </span><span class="str">"b"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="str">"k"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">-</span><span class="lit">100</span><span class="pun">},</span><span class="pln"> </span><span class="str">"c"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="lit">3</span><span class="pun">],</span><span class="pln"> </span><span class="str">"d"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="str">"k"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">100</span><span class="pun">},</span><span class="pln"> </span><span class="str">"e"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="lit">5</span><span class="pun">],</span><span class="pln"> </span><span class="str">"f"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="lit">6</span><span class="pun">]</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

solveFlt</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">,</span><span class="pln"> </span><span class="str">"@maxNum.value[0]"</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">6</span><span class="pln">
solveFlt</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">,</span><span class="pln"> </span><span class="str">"@minNum.value[0]"</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">1</span><span class="pln">
solveFlt</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">,</span><span class="pln"> </span><span class="str">"@maxNum.value.k"</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="lit">100</span><span class="pln">
solveFlt</span><span class="pun">(</span><span class="pln">obj</span><span class="pun">,</span><span class="pln"> </span><span class="str">"@minNum.value.k"</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="pun">-</span><span class="lit">100</span></code></pre>

<h3 id="value-conversion-notes">Value conversion notes</h3>

<p>TODO</p>

<h3 id="object-lifetime-management-rules">Object lifetime management rules</h3>

<p>Q: What the hell is that?</p>

<p>A: You see, each time script creates new string or default papyrus array Skyrim allocates memory and automatically frees it when you do not need that string or array or something else.</p>

<p>Internally all containers are C++ objects, Skyrim knows nothing about them and unable to manage their lifetime and memory.</p>

<p>The lifetime management model is based on object ownership. Any container object may have one or more owners. As long as an object has at least one owner, it continues to exist. If an object has no owners it gets destroyed.</p>

<p>The rules:</p>

<ul>
<li>to prevent destruction you must own container (use <code>JValue.retain</code> function)</li>
<li>when you do not need that object you must release it (use <code>JValue.release</code>)</li>
</ul>

<p>Newly created object (created with object, <code>objectWith*</code> or <code>readFromFile</code> function) owned by no one and destroyed after short amount of time (roughly 10 seconds). Container gets owned(retained) once it gets inserted into another container or JDB(which is also container) and released when removed.</p>

<p>Illustration shows the idea:</p>

<p><img src="https://lh4.googleusercontent.com/-1Q7K-3vT6E8/U1KkKXVAeOI/AAAAAAAAACE/Oief-49GKYs/s0/jcontainers%252520-%252520readme%252520-%252520temp.png" alt="test" title="jcontainers - readme - temp.png"></p>

<h2 id="tutorial">Tutorial</h2>

<h3 id="simple-example">Simple example</h3>

<p>Suppose you want to store some actor related information (let it be player’s followers and their mood):</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="pun">;</span><span class="pln"> initial setup </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">where</span><span class="pln"> you usually </span><span class="kwd">do</span><span class="pln"> the things once mod gets installed
</span><span class="kwd">function</span><span class="pln"> modSetupMethod</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln">create </span><span class="typ">JFormMap</span><span class="pln"> container </span><span class="kwd">and</span><span class="pln"> associate it </span><span class="kwd">with</span><span class="pln"> database </span><span class="kwd">for</span><span class="pln"> future </span><span class="kwd">use</span><span class="pln">
    JDB</span><span class="pun">.</span><span class="pln">setObj</span><span class="pun">(</span><span class="str">"followers"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">JFormMap</span><span class="pun">.</span><span class="kwd">object</span><span class="pun">())</span><span class="pln">
endfunction

</span><span class="pun">;</span><span class="pln"> method that gets called once user uninstalls your mod
</span><span class="kwd">function</span><span class="pln"> modUninstallMethod</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> destroy association to </span><span class="kwd">not</span><span class="pln"> pollute game save
    JDB</span><span class="pun">.</span><span class="pln">setObj</span><span class="pun">(</span><span class="str">"followers"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln">
endfunction

</span><span class="kwd">function</span><span class="pln"> storeFolloverMood</span><span class="pun">(</span><span class="pln">form follower</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">float</span><span class="pln"> mood</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> fetch followers </span><span class="kwd">by</span><span class="pln"> resolving path
    </span><span class="kwd">int</span><span class="pln"> followers </span><span class="pun">=</span><span class="pln"> JDB</span><span class="pun">.</span><span class="pln">solveObj</span><span class="pun">(</span><span class="str">".followers"</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> associate follower </span><span class="kwd">and</span><span class="pln"> the mood
    </span><span class="typ">JFormMap</span><span class="pun">.</span><span class="pln">setFlt</span><span class="pun">(</span><span class="pln">followers</span><span class="pun">,</span><span class="pln"> follower</span><span class="pun">,</span><span class="pln"> mood</span><span class="pun">)</span><span class="pln">
endfunction

</span><span class="kwd">float</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> followerMood</span><span class="pun">(</span><span class="pln">form follower</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> fetch follower mood
    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">JFormMap</span><span class="pun">.</span><span class="pln">getFlt</span><span class="pun">(</span><span class="pln">JDB</span><span class="pun">.</span><span class="pln">solveObj</span><span class="pun">(</span><span class="str">".followers"</span><span class="pun">),</span><span class="pln"> follower</span><span class="pun">)</span><span class="pln">
endfunction</span></code></pre>

<h3 id="config-reading">Config reading</h3>

<p>You wish to have all your mod config values to be stored somewhere (for ex. in <code>"Data/preset.txt"</code> file) so you could easy adjust them all by editing the file. Or you do not wish to hardcode all these values. File contains following info:</p>

<pre class="prettyprint prettyprinted"><code class="language-json"><span class="pun">{</span><span class="pln">
    </span><span class="str">"classicPreset"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">"campfileLighting"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"Automatic"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"exposureRate"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.0</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"frigidWaterLethal"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"exposureIsLethal"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"axeDurability"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pln">
    </span><span class="pun">},</span><span class="pln">
    </span><span class="str">"winterHorkerPreset"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="str">"campfileLighting"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"nonAutomatic"</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"exposureRate"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0.5</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"frigidWaterLethal"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"exposureIsLethal"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln">
        </span><span class="str">"axeDurability"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">}</span></code></pre>

<p>File written in JSON format. <br>
It contains root map containing two maps - two standard presets your mod provides - classicPreset &amp; winterHorkerPreset. Config file reading may look like:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="pun">;</span><span class="pln"> </span><span class="kwd">let</span><span class="pln"> it be </span><span class="pun">.</span><span class="pln">classicPreset </span><span class="kwd">or</span><span class="pln"> </span><span class="pun">.</span><span class="pln">winterHorkerPreset </span><span class="kwd">string</span><span class="pln">
</span><span class="kwd">string</span><span class="pln"> currentPreset

</span><span class="pun">;</span><span class="pln"> </span><span class="kwd">use</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> each time you need re</span><span class="pun">-</span><span class="pln">read preset </span><span class="kwd">from</span><span class="pln"> a file
</span><span class="kwd">function</span><span class="pln"> parseConfig</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> that</span><span class="pun">’</span><span class="pln">s all</span><span class="pun">.</span><span class="pln"> presets are already </span><span class="kwd">in</span><span class="pln"> </span><span class="typ">Skyrim</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> readFromFile returns root map container
    </span><span class="pun">;</span><span class="pln"> it may </span><span class="kwd">return</span><span class="pln"> zero </span><span class="kwd">if</span><span class="pln"> file </span><span class="kwd">not</span><span class="pln"> exist </span><span class="kwd">or</span><span class="pln"> it can </span><span class="kwd">not</span><span class="pln"> be parsed </span><span class="pun">(</span><span class="kwd">not</span><span class="pln"> JSON format </span><span class="kwd">or</span><span class="pln"> you have accidentally added extra coma</span><span class="pun">)</span><span class="pln">
    </span><span class="kwd">int</span><span class="pln"> config </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">readFromFile</span><span class="pun">(</span><span class="str">"Data/preset.txt"</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> put config </span><span class="kwd">into</span><span class="pln"> DB </span><span class="pun">-</span><span class="pln"> associate key </span><span class="kwd">and</span><span class="pln"> config
    JDB</span><span class="pun">.</span><span class="pln">setObj</span><span class="pun">(</span><span class="str">"frostfall"</span><span class="pun">,</span><span class="pln"> config</span><span class="pun">)</span><span class="pln">
    currentPreset </span><span class="pun">=</span><span class="pln"> </span><span class="str">".classicPreset"</span><span class="pln">
endfunction

</span><span class="kwd">bool</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> axeDurabilityEnabled</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> solveInt like any solve</span><span class="pun">*</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> tries to find </span><span class="pun">(</span><span class="pln">solve</span><span class="pun">)</span><span class="pln"> value </span><span class="kwd">for</span><span class="pln"> given path
    </span><span class="pun">;</span><span class="pln"> current path </span><span class="kwd">is</span><span class="pln"> </span><span class="str">".frostfall.classicPreset.axeDurability"</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> JDB</span><span class="pun">.</span><span class="pln">solveInt</span><span class="pun">(</span><span class="str">".frostfall"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> currentPreset </span><span class="pun">+</span><span class="pln"> </span><span class="str">".axeDurability"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">0</span><span class="pln">
endfunction

</span><span class="kwd">string</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> lightingType</span><span class="pun">()</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> JDB</span><span class="pun">.</span><span class="pln">solveStr</span><span class="pun">(</span><span class="str">".frostfall"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> currentPreset </span><span class="pun">+</span><span class="pln"> </span><span class="str">".campfileLighting"</span><span class="pun">)</span><span class="pln">
endfunction</span></code></pre>

<h3 id="config-reading-2">Config reading 2</h3>

<p>Let it be a script that modifies model bone scales (interpolates scales between min and max) and needs configuration data to be imported from file:</p>

<pre class="prettyprint prettyprinted"><code class="language-json"><span class="pun">[</span><span class="pln">
    </span><span class="pun">[</span><span class="str">"NPC Head [Head]"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.33</span><span class="pun">],</span><span class="pln">
    </span><span class="pun">[</span><span class="str">"NPC Spine [Spn0]"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.133</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.3</span><span class="pun">],</span><span class="pln">
    </span><span class="pun">[</span><span class="str">"NPC Spine1 [Spn1]"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0.433</span><span class="pun">],</span><span class="pln">
    </span><span class="pun">[</span><span class="str">"NPC Spine2 [Spn2]"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.167</span><span class="pun">]</span><span class="pln">
</span><span class="pun">]</span></code></pre>

<p>What you see here is one array that contains 4 sub-arrays and each sub-array contains model bone name, minimum and maximum scale.Then script would look like:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="kwd">import</span><span class="pln"> </span><span class="typ">JArray</span><span class="pln">
</span><span class="kwd">import</span><span class="pln"> </span><span class="typ">JMap</span><span class="pln">
</span><span class="kwd">import</span><span class="pln"> </span><span class="typ">JValue</span><span class="pln">
</span><span class="kwd">import</span><span class="pln"> JDB

</span><span class="kwd">int</span><span class="pln"> config </span><span class="pun">=</span><span class="lit">0</span><span class="pln">

</span><span class="typ">EventOnEffectStart</span><span class="pun">(</span><span class="typ">Actor</span><span class="pln"> akTarget</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Actor</span><span class="pln"> akCaster</span><span class="pun">)</span><span class="pln">
</span><span class="pun">;</span><span class="pln"> read config file </span><span class="kwd">from</span><span class="pln"> game root folder
config </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">readFromFile</span><span class="pun">(</span><span class="str">"scale.txt"</span><span class="pun">)</span><span class="pln">
</span><span class="typ">Endevent</span><span class="pln">

</span><span class="kwd">function</span><span class="pln"> setScale</span><span class="pun">(</span><span class="kwd">float</span><span class="pln"> scale</span><span class="pun">)</span><span class="pln">
    objectreference plr </span><span class="pun">=</span><span class="pln"> </span><span class="typ">GetTargetActor</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> iterate over array </span><span class="pun">&amp;</span><span class="pln"> calculate bone scale
    </span><span class="kwd">int</span><span class="pln"> i </span><span class="pun">=</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(</span><span class="pln">config</span><span class="pun">)</span><span class="pln">
    </span><span class="kwd">while</span><span class="pun">(</span><span class="pln">i </span><span class="pun">&gt;</span><span class="lit">0</span><span class="pun">)</span><span class="pln">
     i </span><span class="pun">-=</span><span class="lit">1</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> currently </span><span class="pun">|</span><span class="pln">data</span><span class="pun">|</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> array</span><span class="pun">.</span><span class="pln"> </span><span class="pun">[</span><span class="str">"NPC Head [Head]"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">0.33</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> example
     </span><span class="kwd">int</span><span class="pln"> data</span><span class="pun">=</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getObj</span><span class="pun">(</span><span class="pln">config</span><span class="pun">,</span><span class="pln"> i</span><span class="pun">)</span><span class="pln">
     </span><span class="kwd">float</span><span class="pln"> nodeScale </span><span class="pun">=</span><span class="lit">1.0</span><span class="pun">+</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getFlt</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getFlt</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="lit">2</span><span class="pun">)-</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getFlt</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="lit">1</span><span class="pun">))</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> scale
    </span><span class="typ">NetImmerse</span><span class="pun">.</span><span class="typ">SetNodeScale</span><span class="pun">(</span><span class="pln">plr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">getStr</span><span class="pun">(</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">),</span><span class="pln"> nodeScale</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span><span class="pln">
    endWhile
endfunction</span></code></pre>

<p>you could rewrite script to store config data in JDB and not in effect script:</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="typ">EventOnEffectStart</span><span class="pun">(</span><span class="typ">Actor</span><span class="pln"> akTarget</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Actor</span><span class="pln"> akCaster</span><span class="pun">)</span><span class="pln">
    JDB</span><span class="pun">.</span><span class="pln">setObj</span><span class="pun">(</span><span class="str">"scaleMod"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">readFromFile</span><span class="pun">(</span><span class="str">"scale.txt"</span><span class="pun">))</span><span class="pln">
</span><span class="typ">Endevent</span><span class="pln">

</span><span class="pun">;</span><span class="pln"> access data somewhere later</span><span class="pun">.</span><span class="pln"> JDB resolves path</span><span class="pun">:</span><span class="pln">
</span><span class="kwd">int</span><span class="pln"> config </span><span class="pun">=</span><span class="pln"> JDB</span><span class="pun">.</span><span class="pln">solveObj</span><span class="pun">(</span><span class="str">".scaleMod"</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">int</span><span class="pln"> i </span><span class="pun">=</span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">count</span><span class="pun">(</span><span class="pln">config</span><span class="pun">)</span><span class="pln">
</span><span class="kwd">while</span><span class="pun">(</span><span class="pln">i </span><span class="pun">&gt;</span><span class="lit">0</span><span class="pun">)</span><span class="pln">
</span><span class="pun">…</span></code></pre>

<h3 id="followers-example">Followers example</h3>

<p>The same as first example, but now you need to store one more value - anger and list of victims (both are per-actor data). Also you have decided to not associate followers with JDB database.</p>

<p>We will store all per-actor information in following structure:</p>

<pre class="prettyprint prettyprinted"><code class="language-json"><span class="pun">{</span><span class="pln">
    </span><span class="str">"mood"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"anger"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln">
    </span><span class="str">"victims"</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[]</span><span class="pln">
</span><span class="pun">}</span></code></pre>

<p>Here you can see a map that contains 3 key-value associations: mood &amp; angler(both are zeros initially) and string key (“victims”) -&gt; array association.</p>

<pre class="prettyprint prettyprinted"><code class="language-lua"><span class="kwd">function</span><span class="pln"> storeFollowerMood</span><span class="pun">(</span><span class="pln">form follower</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">float</span><span class="pln"> mood</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> follower entry to write </span><span class="kwd">into</span><span class="pln"> it
    </span><span class="kwd">int</span><span class="pln"> entry </span><span class="pun">=</span><span class="pln"> getActorEntry</span><span class="pun">(</span><span class="pln">follower</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> write mood </span><span class="kwd">into</span><span class="pln"> follower entry
    </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveFltSetter</span><span class="pun">(</span><span class="pln">entry</span><span class="pun">,</span><span class="pln"> </span><span class="str">".mood"</span><span class="pun">,</span><span class="pln"> mood</span><span class="pun">)</span><span class="pln">
endfunction

</span><span class="kwd">function</span><span class="pln"> addFollowerVictim</span><span class="pun">(</span><span class="pln">form follower</span><span class="pun">,</span><span class="pln"> form victim</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> follower entry to write </span><span class="kwd">into</span><span class="pln"> it AND </span><span class="kwd">then</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> victims array
    </span><span class="kwd">int</span><span class="pln"> victims </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveObj</span><span class="pun">(</span><span class="pln">getActorEntry</span><span class="pun">(</span><span class="pln">follower</span><span class="pun">),</span><span class="pln"> </span><span class="str">".victims"</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> add victim </span><span class="kwd">into</span><span class="pln"> array
    </span><span class="typ">JArray</span><span class="pun">.</span><span class="pln">addForm</span><span class="pun">(</span><span class="pln">victims</span><span class="pun">,</span><span class="pln"> victim</span><span class="pun">)</span><span class="pln">
endfunction

</span><span class="kwd">float</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> followerMood</span><span class="pun">(</span><span class="pln">form follower</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> follower entry AND fetch mood
    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveFlt</span><span class="pun">(</span><span class="pln">getActorEntry</span><span class="pun">(</span><span class="pln">follower</span><span class="pun">),</span><span class="pln"> </span><span class="str">".mood"</span><span class="pun">)</span><span class="pln">
endfunction

</span><span class="kwd">float</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> followerAnger</span><span class="pun">(</span><span class="pln">form follower</span><span class="pun">)</span><span class="pln">
    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">solveFlt</span><span class="pun">(</span><span class="pln">getActorEntry</span><span class="pun">(</span><span class="pln">follower</span><span class="pun">),</span><span class="pln"> </span><span class="str">".anger"</span><span class="pun">)</span><span class="pln">
endfunction

</span><span class="pun">;</span><span class="pln"> find </span><span class="pun">(</span><span class="kwd">or</span><span class="pln"> create </span><span class="kwd">new</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> found</span><span class="pun">)</span><span class="pln"> per</span><span class="pun">-</span><span class="pln">actor information containing mood</span><span class="pun">,</span><span class="pln"> anger </span><span class="kwd">and</span><span class="pln"> array of victims
</span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> getActorEntry</span><span class="pun">(</span><span class="pln">form actor</span><span class="pun">)</span><span class="pln">
    </span><span class="kwd">int</span><span class="pln"> entry </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JFormMap</span><span class="pun">.</span><span class="pln">getObj</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">followers</span><span class="pun">,</span><span class="pln"> follower</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">no</span><span class="pln"> entry found </span><span class="pun">-</span><span class="pln"> create </span><span class="kwd">new</span><span class="pln"> </span><span class="kwd">from</span><span class="pln"> prototype</span><span class="pun">-</span><span class="kwd">string</span><span class="pln">
    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">!</span><span class="pln">entry
        </span><span class="kwd">int</span><span class="pln"> entry </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">objectWithPrototype</span><span class="pun">(</span><span class="str">"{ \"mood\": 0, \"anger\": 0, \"victims\": [] }"</span><span class="pun">)</span><span class="pln">
        </span><span class="typ">JFormMap</span><span class="pun">.</span><span class="pln">setObj</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">followers</span><span class="pun">,</span><span class="pln"> follower</span><span class="pun">,</span><span class="pln"> entry</span><span class="pun">)</span><span class="pln">
    endif

    </span><span class="kwd">return</span><span class="pln"> entry
endfunction

</span><span class="pun">;</span><span class="pln"> that property hides all black magick </span><span class="pun">-</span><span class="pln"> retains </span><span class="pun">&amp;</span><span class="pln"> releases </span><span class="kwd">object</span><span class="pln">
</span><span class="pun">;</span><span class="pln"> see </span><span class="typ">Object</span><span class="pln"> lifetime management rules section </span><span class="kwd">for</span><span class="pln"> more of it
</span><span class="kwd">int</span><span class="pln"> property followers hidden
    </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">()</span><span class="pln">
        </span><span class="kwd">return</span><span class="pln"> _followers
    endFunction
    </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">set</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> value</span><span class="pun">)</span><span class="pln">
        </span><span class="pun">;</span><span class="pln"> retainAndRelease releases previous </span><span class="kwd">object</span><span class="pln">
        </span><span class="pun">;</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> owns </span><span class="pun">(</span><span class="pln">retains</span><span class="pun">)</span><span class="pln"> a </span><span class="kwd">new</span><span class="pln">
        _followers </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JValue</span><span class="pun">.</span><span class="pln">releaseAndRetain</span><span class="pun">(</span><span class="pln">_followers</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">)</span><span class="pln">
    endFunction
endProperty

</span><span class="kwd">int</span><span class="pln"> _followers </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pln">

</span><span class="pun">;</span><span class="pln"> initial setup </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">where</span><span class="pln"> you usually </span><span class="kwd">do</span><span class="pln"> the things once mod gets installed

</span><span class="kwd">function</span><span class="pln"> modSetupMethod</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> create </span><span class="kwd">and</span><span class="pln"> retain </span><span class="typ">JFormMap</span><span class="pln"> container
    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">followers </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JFormMap</span><span class="pun">.</span><span class="kwd">object</span><span class="pun">()</span><span class="pln">
endfunction

</span><span class="pun">;</span><span class="pln"> method that gets called once user uninstalls it via MCM
</span><span class="kwd">function</span><span class="pln"> modUninstallMethod</span><span class="pun">()</span><span class="pln">
    </span><span class="pun">;</span><span class="pln"> release followers container to </span><span class="kwd">not</span><span class="pln"> pollute game save
    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">followers </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pln">
endfunction</span></code></pre></div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-43754853-5");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>
</body>
</html>